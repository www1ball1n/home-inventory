<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>å®¶åº­ç‰©å“ç®¡ç†ç³»ç»Ÿ</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  h1 { color: #2c3e50; }
  #path { font-size: 14px; color: #666; margin: 6px 0 10px; }
  ul { list-style-type: none; padding-left: 20px; }
  li { margin: 5px 0; }
  .space { font-weight: bold; cursor: pointer; }
  .item.used { color: gray; text-decoration: line-through; }
  button { margin-left: 5px; }
  /* æœç´¢åŒº */
  #searchWrap { margin: 10px 0; }
  #results { margin-top: 6px; }
  .result { padding: 4px 6px; border: 1px solid #ddd; border-radius: 6px; margin: 4px 0; }
  .result strong { margin-right: 6px; }
  .breadcrumb { font-size: 12px; color: #666; }
  /* é«˜äº®é—ªçƒ */
  .flash {
    animation: flashbg 1.2s ease-out 1;
  }
  @keyframes flashbg {
    0% { background: #fff59d; }
    100% { background: transparent; }
  }
</style>
</head>
<body>
  <h1>ğŸ“¦ å®¶åº­ç‰©å“ç®¡ç†ç³»ç»Ÿï¼ˆæ ‘çŠ¶ç»“æ„ + å±•å¼€/æ”¶èµ· + æœç´¢ï¼‰</h1>

  <!-- è·¯å¾„ -->
  <div id="path"></div>

  <!-- å…¨å±€æŒ‰é’® -->
  <div>
    <button onclick="addSpace()">+ç©ºé—´</button>
    <button onclick="addItem()">+ç‰©å“</button>
    <button onclick="goBack()">è¿”å›ä¸Šçº§</button>
    <button onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
    <input type="file" id="importFile" style="display:none" accept=".json" onchange="importData(event)" />
    <button onclick="document.getElementById('importFile').click()">å¯¼å…¥æ•°æ®</button>
  </div>

  <!-- æœç´¢ -->
  <div id="searchWrap">
    <input id="searchInput" placeholder="æœç´¢åç§°æˆ–æè¿°ï¼ˆå…¨å±€ï¼‰" oninput="onSearchInput()" />
    <button onclick="clearSearch()">æ¸…é™¤</button>
    <div id="results"></div>
  </div>

  <!-- æ ‘/åˆ—è¡¨ -->
  <ul id="list"></ul>

  <script>
    // ------------ æ•°æ®ä¸çŠ¶æ€ ------------
    let data = JSON.parse(localStorage.getItem("storageTree")) || {
      name: "ğŸ  å®¶åº­", type: "space", children: [], expanded: true
    };
    let currentPath = [data]; // è·¯å¾„æ ˆï¼šä»æ ¹å¼€å§‹
    let flashTargetId = null; // ç”¨äºç‰©å“å®šä½åé«˜äº®

    // ç»™æ¯ä¸ªèŠ‚ç‚¹åˆ†é…ä¸€ä¸ªç®€æ˜“ idï¼ˆé¦–æ¬¡è¿è¡Œæˆ–æ–°å»ºæ—¶ï¼‰
    function ensureIds(node) {
      if (!node.id) node.id = "n_" + Math.random().toString(36).slice(2, 9);
      if (node.type === "space" && Array.isArray(node.children)) {
        node.children.forEach(ensureIds);
      }
    }
    ensureIds(data);

    function saveData() {
      localStorage.setItem("storageTree", JSON.stringify(data));
    }
    function getCurrentNode() {
      return currentPath[currentPath.length - 1];
    }
    function updatePathDisplay() {
      document.getElementById("path").textContent =
        "è·¯å¾„: " + currentPath.map(n => n.name).join(" > ");
    }

    // æ ¹æ®èŠ‚ç‚¹æŸ¥æ‰¾ä»æ ¹åˆ°è¯¥èŠ‚ç‚¹çš„è·¯å¾„
    function findPath(root, target) {
      const path = [];
      function dfs(node) {
        path.push(node);
        if (node === target) return true;
        if (node.type === "space") {
          for (const child of node.children) {
            if (dfs(child)) return true;
          }
        }
        path.pop();
        return false;
      }
      dfs(root);
      return path;
    }
    
    // å¯¼å‡ºæ•°æ®
    function exportData() {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "storage_data.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // å¯¼å…¥æ•°æ®
    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const imported = JSON.parse(e.target.result);
          if (imported && imported.type === "space" && Array.isArray(imported.children)) {
            data = imported;
            ensureIds(data);
            currentPath = [data];
            saveData();
            updatePathDisplay();
            renderList();
            document.getElementById("searchInput").value = "";
            document.getElementById("results").innerHTML = "";
            alert("æ•°æ®å¯¼å…¥æˆåŠŸï¼");
          } else {
            alert("æ— æ•ˆçš„æ•°æ®æ ¼å¼ï¼");
          }
        } catch (err) {
          alert("è¯»å–æ–‡ä»¶å¤±è´¥æˆ–æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼");
        }
      };
      reader.readAsText(file);
      event.target.value = ""; // æ¸…ç©ºä»¥ä¾¿ä¸‹æ¬¡å¯¼å…¥åŒä¸€æ–‡ä»¶
    }

    // ------------ æ¸²æŸ“æ ‘ ------------
    function renderNode(node, parent) {
      const li = document.createElement("li");

      if (node.type === "space") {
        // ç®­å¤´ â–¶ â–¼
        const arrow = document.createElement("span");
        arrow.textContent = node.expanded ? "â–¼ " : "â–¶ ";
        arrow.style.cursor = "pointer";
        arrow.onclick = () => {
          node.expanded = !node.expanded;
          saveData(); renderList();
        };

        // æ–‡ä»¶å¤¹ï¼ˆåŒå‡»è¿›å…¥ï¼‰
        const span = document.createElement("span");
        span.textContent = "ğŸ“‚ " + node.name;
        span.className = "space";
        span.ondblclick = () => {
          currentPath = findPath(data, node);
          updatePathDisplay();
          renderList();
        };

        li.appendChild(arrow);
        li.appendChild(span);

        // æ–‡ä»¶å¤¹åŠŸèƒ½ï¼šåˆ é™¤ã€+ç‰©å“ã€+å­ç©ºé—´
        const addItemBtn = document.createElement("button");
        addItemBtn.textContent = "+ç‰©å“";
        addItemBtn.onclick = () => {
          const name = prompt("è¯·è¾“å…¥ç‰©å“åç§°ï¼š");
          if (name) {
            const item = { id: "n_" + Math.random().toString(36).slice(2, 9), name, type: "item", used: false };
            node.children.push(item);
            saveData(); renderList();
          }
        };
        li.appendChild(addItemBtn);

        const addSpaceBtn = document.createElement("button");
        addSpaceBtn.textContent = "+å­ç©ºé—´";
        addSpaceBtn.onclick = () => {
          const name = prompt("è¯·è¾“å…¥å­ç©ºé—´åç§°ï¼š");
          if (name) {
            const child = { id: "n_" + Math.random().toString(36).slice(2, 9), name, type: "space", children: [], expanded: true };
            node.children.push(child);
            saveData(); renderList();
          }
        };
        li.appendChild(addSpaceBtn);

        const delBtn = document.createElement("button");
        delBtn.textContent = "âŒ";
        delBtn.onclick = () => {
          if (confirm("ç¡®è®¤åˆ é™¤ç©ºé—´ï¼Ÿ")) {
            const idx = parent.children.indexOf(node);
            parent.children.splice(idx, 1);
            saveData(); renderList();
          }
        };
        li.appendChild(delBtn);

        // å­æ ‘
        if (node.expanded) {
          const ul = document.createElement("ul");
          node.children.forEach(child => {
            ul.appendChild(renderNode(child, node));
          });
          li.appendChild(ul);
        }
      } else {
        // ç‰©å“
        const span = document.createElement("span");
        span.textContent = "ğŸ“¦ " + node.name + (node.desc ? " (" + node.desc + ")" : "");
        span.className = "item";
        if (node.used) span.classList.add("used");
        span.id = node.id; // ç”¨äºå®šä½é«˜äº®
        if (flashTargetId === node.id) {
          span.classList.add("flash");
          setTimeout(() => {
            span.classList.remove("flash");
            if (flashTargetId === node.id) flashTargetId = null;
          }, 1200);
        }
        li.appendChild(span);

        // ç”¨å®Œ
        const usedBtn = document.createElement("button");
        usedBtn.textContent = "ç”¨å®Œ";
        usedBtn.onclick = () => {
          node.used = !node.used;
          saveData(); renderList();
        };
        li.appendChild(usedBtn);

        // æè¿°
        const descBtn = document.createElement("button");
        descBtn.textContent = "æè¿°";
        descBtn.onclick = () => {
          const desc = prompt("è¯·è¾“å…¥ç‰©å“æè¿°ï¼š", node.desc || "");
          if (desc !== null) {
            node.desc = desc;
            saveData(); renderList();
          }
        };
        li.appendChild(descBtn);

        // åˆ é™¤
        const delBtn = document.createElement("button");
        delBtn.textContent = "âŒ";
        delBtn.onclick = () => {
          if (confirm("ç¡®è®¤åˆ é™¤ç‰©å“ï¼Ÿ")) {
            const idx = parent.children.indexOf(node);
            parent.children.splice(idx, 1);
            saveData(); renderList();
          }
        };
        li.appendChild(delBtn);
      }
      return li;
    }

    function renderList() {
      const list = document.getElementById("list");
      list.innerHTML = "";
      const node = getCurrentNode();
      node.children.forEach(child => list.appendChild(renderNode(child, node)));
    }

    // ------------ å…¨å±€æŒ‰é’® ------------
    function addSpace() {
      const name = prompt("è¯·è¾“å…¥ç©ºé—´åç§°ï¼š");
      if (name) {
        const child = { id: "n_" + Math.random().toString(36).slice(2, 9), name, type: "space", children: [], expanded: true };
        getCurrentNode().children.push(child);
        saveData(); renderList();
      }
    }
    function addItem() {
      const name = prompt("è¯·è¾“å…¥ç‰©å“åç§°ï¼š");
      if (name) {
        const item = { id: "n_" + Math.random().toString(36).slice(2, 9), name, type: "item", used: false };
        getCurrentNode().children.push(item);
        saveData(); renderList();
      }
    }
    function goBack() {
      if (currentPath.length > 1) {
        currentPath.pop();
        updatePathDisplay();
        renderList();
      }
    }

    // ------------ æœç´¢ ------------
    function onSearchInput() {
      const q = document.getElementById("searchInput").value.trim().toLowerCase();
      const resultsBox = document.getElementById("results");
      resultsBox.innerHTML = "";
      if (!q) {
        updatePathDisplay();
        renderList();
        return;
      }
      const hits = searchAll(data, q); // è¿”å›åŒ¹é…çš„èŠ‚ç‚¹æ•°ç»„
      if (hits.length === 0) {
        resultsBox.textContent = "æ— åŒ¹é…ç»“æœ";
        return;
      }
      hits.forEach(hit => {
        const div = document.createElement("div");
        div.className = "result";
        const typeLabel = hit.node.type === "space" ? "ğŸ“‚" : "ğŸ“¦";
        const name =
          hit.node.name +
          (hit.node.type === "item" && hit.node.desc ? " (" + hit.node.desc + ")" : "") +
          (hit.node.type === "item" && hit.node.used ? "ï¼ˆå·²ç”¨å®Œï¼‰" : "");
        const strong = document.createElement("strong");
        strong.textContent = `${typeLabel} ${name}`;
        const bc = document.createElement("div");
        bc.className = "breadcrumb";
        bc.textContent = "è·¯å¾„: " + hit.path.map(n => n.name).join(" > ");

        const gotoBtn = document.createElement("button");
        gotoBtn.textContent = "å®šä½";
        gotoBtn.onclick = () => {
          // è®¾ç½® currentPath
          currentPath = [...hit.path]; // åˆ°è¾¾è¯¥èŠ‚ç‚¹ï¼ˆå¦‚æœæ˜¯ itemï¼Œè·¯å¾„ä»¥çˆ¶ç©ºé—´ç»“å°¾ï¼›å¦‚æœæ˜¯ç©ºé—´ï¼Œè·¯å¾„ä»¥è¯¥ç©ºé—´ç»“å°¾ï¼‰
          // ç¡®ä¿æ²¿é€”å…¨éƒ¨å±•å¼€
          currentPath.forEach(n => { if (n.type === "space") n.expanded = true; });
          updatePathDisplay();

          if (hit.node.type === "space") {
            // å¦‚æœæ˜¯ç©ºé—´ï¼šè¿›å…¥è¯¥ç©ºé—´å³å¯
            renderList();
          } else {
            // å¦‚æœæ˜¯ç‰©å“ï¼šè¿›å…¥çˆ¶ç©ºé—´å¹¶é«˜äº®è¯¥ç‰©å“
            flashTargetId = hit.node.id;
            renderList();
            // æ»šåŠ¨åˆ°è§†å›¾
            const el = document.getElementById(hit.node.id);
            if (el) el.scrollIntoView({ behavior: "smooth", block: "center" });
          }
        };

        div.appendChild(strong);
        div.appendChild(gotoBtn);
        div.appendChild(bc);
        resultsBox.appendChild(div);
      });
    }

    // æ·±åº¦ä¼˜å…ˆæœç´¢ï¼Œè¿”å›åŒ¹é…å‘½ä¸­
    // å‘½ä¸­ç»“æ„ï¼š{ node, path }ï¼›path ä¸ºæ•°ç»„ï¼ˆä»æ ¹åˆ°ç›®æ ‡çš„â€œçˆ¶ç©ºé—´â€æˆ–ç©ºé—´æœ¬èº«ï¼‰
    function searchAll(root, q) {
      const hits = [];
      function dfs(node, path) {
        if (node.type === "space") {
          // åŒ¹é…ç©ºé—´å
          if (node.name.toLowerCase().includes(q)) {
            hits.push({ node, path: [...path, node] });
          }
          // éå†å­èŠ‚ç‚¹
          node.children.forEach(child => {
            if (child.type === "space") {
              dfs(child, [...path, node]);
            } else {
              // ç‰©å“åŒ¹é…ï¼šåç§°æˆ–æè¿°
              const txt = (child.name + " " + (child.desc || "")).toLowerCase();
              if (txt.includes(q)) {
                hits.push({ node: child, path: [...path, node] }); // path ä»¥çˆ¶ç©ºé—´ç»“å°¾
              }
            }
          });
        }
      }
      dfs(root, []);
      return hits;
    }

    function clearSearch() {
      document.getElementById("searchInput").value = "";
      document.getElementById("results").innerHTML = "";
      updatePathDisplay();
      renderList();
    }

    // ------------ åˆå§‹åŒ– ------------
    updatePathDisplay();
    renderList();
  </script>
</body>
</html>
